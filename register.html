<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>REGISTER | ECHELON '26</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
:root {
  --maroon: #4B0036;
  --gold: #D4AF37;
  --gold-grad: linear-gradient(135deg, #D4AF37 0%, #F5F1E6 50%, #D4AF37 100%);
  --cream: #F5F1E6;
  --card-bg: rgba(75, 0, 54, 0.6);
  --input-bg: rgba(45, 0, 33, 0.8);
  --transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
  --error: #ff4d4d;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: radial-gradient(circle at center, #630048 0%, #4B0036 100%);
  color: var(--cream);
  font-family: 'Montserrat', sans-serif;
  min-height: 100vh;
  padding: 20px;
}

.header-branding {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 30px;
  margin-bottom: 40px;
}

.logo { width: 70px; height: auto; filter: drop-shadow(0 0 8px rgba(0,0,0,0.5)); }

.container {
  max-width: 900px;
  margin: 0 auto;
  padding: 40px;
  background: var(--card-bg);
  backdrop-filter: blur(15px);
  border: 1px solid rgba(212, 175, 55, 0.3);
  border-radius: 20px;
  box-shadow: 0 20px 50px rgba(0,0,0,0.5);
}

h1 {
  font-family: 'Cinzel', serif;
  background: var(--gold-grad);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-align: center;
  font-size: 2rem;
  margin-bottom: 10px;
}

h2 {
  font-family: 'Cinzel', serif;
  color: var(--gold);
  font-size: 1.2rem;
  margin-bottom: 25px;
  text-align: center;
  letter-spacing: 2px;
}

.instruction-text {
  text-align: center;
  font-size: 0.85rem;
  color: var(--gold);
  margin-bottom: 20px;
  font-style: italic;
}

.progress {
  display: flex;
  justify-content: space-between;
  margin-bottom: 40px;
}

.progress div {
  flex: 1;
  height: 4px;
  background: rgba(212, 175, 55, 0.2);
  margin: 0 5px;
  border-radius: 10px;
  transition: var(--transition);
}

.progress div.active {
  background: var(--gold);
  box-shadow: 0 0 10px var(--gold);
}

.step { display: none; animation: fade .5s ease forwards; }
.step.active { display: block; }

@keyframes fade {
  from { opacity: 0; transform: translateY(15px); }
  to { opacity: 1; transform: translateY(0); }
}

.option {
  padding: 20px;
  border: 1px solid rgba(212, 175, 55, 0.3);
  background: rgba(255,255,255,0.03);
  border-radius: 10px;
  cursor: pointer;
  transition: var(--transition);
  margin-bottom: 15px;
  position: relative;
  overflow: hidden;
}

.option:hover:not(.disabled) { border-color: var(--gold); background: rgba(212, 175, 55, 0.05); transform: translateY(-3px); }

.option.selected {
  background: var(--gold-grad);
  color: var(--maroon);
  border-color: transparent;
  font-weight: 700;
}

.option.disabled {
  opacity: 0.5;
  cursor: not-allowed;
  border-color: var(--error);
}

.event-meta {
  font-size: 0.8rem;
  margin-top: 8px;
  display: block;
  opacity: 0.9;
}

.full-tag {
  color: var(--error);
  font-weight: bold;
  font-family: 'Cinzel';
  margin-top: 5px;
}

.input-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-top: 15px;
}

.input-wrapper { position: relative; }

.input-wrapper i {
  position: absolute;
  left: 15px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--gold);
}

input {
  width: 100%;
  padding: 14px 14px 14px 45px;
  border-radius: 8px;
  border: 1px solid rgba(212, 175, 55, 0.3);
  background: var(--input-bg);
  color: var(--cream);
  font-family: 'Montserrat', sans-serif;
  transition: var(--transition);
}

input:focus {
  outline: none;
  border-color: var(--gold);
  box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
}

.common-box {
  border: 2px solid var(--gold);
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 30px;
  background: rgba(212, 175, 55, 0.05);
}

.participant-section {
  border: 1px solid rgba(212, 175, 55, 0.3);
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
}

.participant-title {
  color: var(--gold);
  font-family: 'Cinzel';
  font-size: 0.9rem;
  margin-bottom: 15px;
  display: block;
  border-bottom: 1px solid rgba(212, 175, 55, 0.2);
  padding-bottom: 5px;
}

.btn-container { display: flex; gap: 15px; margin-top: 35px; }

button {
  flex: 1;
  padding: 15px;
  background: transparent;
  border: 1px solid var(--gold);
  color: var(--gold);
  cursor: pointer;
  font-family: 'Cinzel', serif;
  font-weight: 700;
  text-transform: uppercase;
  border-radius: 8px;
  transition: var(--transition);
}

button:hover:not(:disabled) { background: var(--gold-grad); color: var(--maroon); border-color: transparent; }
button:disabled { opacity: 0.6; cursor: not-allowed; border-color: gray; color: gray; }

.summary-box {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(212, 175, 55, 0.2);
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
}

.fee-box {
  background: var(--gold-grad);
  color: var(--maroon);
  padding: 20px;
  border-radius: 10px;
  text-align: center;
  font-weight: 800;
  font-family: 'Cinzel', serif;
  margin-top: 10px;
}

.qr-section {
  text-align: center;
  margin: 30px 0;
  padding: 20px;
  background: white;
  border-radius: 15px;
}

.qr-section img { width: 200px; }

</style>
</head>
<body>

<div class="header-branding">
  <img src="https://lh3.googleusercontent.com/d/1JAn4QUP7_QA1jymyHLBpQQ4gicuXgliV" class="logo" alt="RKMVC Logo">
  <div style="text-align:center">
    <h1>ECHELON '26</h1>
    <p style="font-family:'Cinzel'; font-size: 0.7rem; color: var(--gold); letter-spacing: 3px;">REGISTRATION PORTAL</p>
  </div>
  <img src="https://lh3.googleusercontent.com/d/167gpyrjV3XO-mx31F_nsqXX7c6lE6QoY" class="logo" alt="FINSpire Logo">
</div>

<div class="container">
  <div class="progress">
    <div id="p1" class="active"></div>
    <div id="p2"></div>
    <div id="p3"></div>
    <div id="p4"></div>
  </div>

  <form id="masterForm" onsubmit="return false;">
    <div class="step active" id="step1">
      <h2>Select Event Day(s)</h2>
      <p class="instruction-text">Note: You may choose either day or both days to participate.</p>
      <div class="option" onclick="toggleDate('March 10',this)">March 10 <i class="fas fa-calendar-day" style="float:right"></i></div>
      <div class="option" onclick="toggleDate('March 11',this)">March 11 <i class="fas fa-calendar-day" style="float:right"></i></div>
      <div class="btn-container"><button type="button" onclick="goToEvents()">Next Step</button></div>
    </div>

    <div class="step" id="step2">
      <h2>Select Your Event(s)</h2>
      <div id="march10Events"></div>
      <div id="march11Events"></div>
      <div class="btn-container">
        <button type="button" onclick="prevStep(1)">Back</button>
        <button type="button" onclick="goToDetails()">Continue</button>
      </div>
    </div>

    <div class="step" id="step3">
      <h2>Participant Details</h2>
      <div id="dynamicForm"></div>
      <div class="btn-container">
        <button type="button" onclick="prevStep(2)">Back</button>
        <button type="button" onclick="validateStep3()">Proceed to Payment</button>
      </div>
    </div>

    <div class="step" id="step4">
      <h2>Payment & Verification</h2>
      <div id="paymentSummary"></div>
      <div class="fee-box">TOTAL PAYABLE: ₹<span id="totalAmount">0</span></div>
      
      <div class="qr-section">
        <p style="color: #333; margin-bottom: 10px; font-weight: 700; font-family: 'Cinzel';">SCAN TO PAY</p>
        <img src="YOUR_QR_IMAGE_LINK_HERE" alt="Payment QR">
      </div>
      
      <div class="input-grid">
        <div class="input-wrapper"><i class="fas fa-receipt"></i><input id="txnId" placeholder="Paste or Enter UPI Transaction ID"></div>
        <div class="input-wrapper"><i class="fas fa-file-upload"></i><input type="file" id="screenshot" accept="image/*"></div>
      </div>
      
      <label style="display: block; margin-top: 20px; font-size: 0.8rem; cursor: pointer;">
        <input type="checkbox" id="declaration" style="width: auto; margin-right: 10px;">
        I confirm payment has been initiated for the total amount.
      </label>
      
      <div class="btn-container">
        <button type="button" onclick="prevStep(3)">Back</button>
        <button type="button" onclick="submitFinalRegistration()">Submit Registration</button>
      </div>
    </div>
  </form>
</div>

<script>
const eventData = {
  "March 10": [
    {name:"Make or Break", fee:150, type:"team", capacity: 18, sizeRule: "Team Size: 2–4 Members"},
    {name:"Quizpreneur", fee:150, type:"team", capacity: 50, sizeRule: "Team Size: 2–4 Members"},
    {name:"Behind the Brand", fee:150, type:"team", capacity: 20, sizeRule: "Team Size: 2–4 Members"}
  ],
  "March 11": [
    {name:"Biz Auction", fee:150, type:"biz", capacity: 5, sizeRule: "Team Size: Exactly 4 Members"},
    {name:"Decision Table", fee:150, type:"team", capacity: 30, sizeRule: "Team Size: 2–4 Members"},
    {name:"Identity Unleashed", fee:50, type:"individual", capacity: 100, sizeRule: "Individual Only (1 Participant)"}
  ]
};

let selectedDates = [];
let selectedEvents = {};

function updateProgress(step){
  document.querySelectorAll(".progress div").forEach(p=>p.classList.remove("active"));
  document.getElementById("p"+step).classList.add("active");
}

function nextStep(step){
  document.querySelectorAll(".step").forEach(s=>s.classList.remove("active"));
  document.getElementById("step"+step).classList.add("active");
  updateProgress(step);
  window.scrollTo({top: 0, behavior: 'smooth'});
}

function prevStep(step){nextStep(step)}

function toggleDate(date,el){
  if(selectedDates.includes(date)){
    selectedDates=selectedDates.filter(d=>d!==date);
    delete selectedEvents[date];
    el.classList.remove("selected");
  }else{
    selectedDates.push(date);
    el.classList.add("selected");
  }
}

function goToEvents(){
  if(selectedDates.length===0){ alert("Selection Required: Please select at least one date."); return; }
  buildEventOptions();
  nextStep(2);
}

function buildEventOptions(){
  document.getElementById("march10Events").innerHTML="";
  document.getElementById("march11Events").innerHTML="";
  
  selectedDates.forEach(date=>{
    let container=document.getElementById(date==="March 10"?"march10Events":"march11Events");
    container.innerHTML+=`<h3 style="color:var(--gold); font-family:'Cinzel'; margin: 20px 0 10px;">${date}</h3>`;
    
    eventData[date].forEach(ev=>{
      const isFull = ev.capacity <= 0;
      const card = document.createElement('div');
      card.className = `option ${isFull ? 'disabled' : ''}`;
      if(selectedEvents[date] && selectedEvents[date].name === ev.name) card.classList.add('selected');
      
      card.innerHTML = `
        <div style="flex:1">
          <strong>${ev.name}</strong><br>
          <span class="event-meta">₹${ev.fee} per ${ev.type === 'individual' ? 'person' : 'team'}</span>
          <span class="event-meta">${ev.sizeRule}</span>
          ${isFull ? '<div class="full-tag">EVENT FULL</div>' : `<span class="event-meta" style="color:var(--gold)">Slots Left: ${ev.capacity}</span>`}
        </div>
      `;
      
      if(!isFull) card.onclick = () => selectEvent(date, ev, card);
      container.appendChild(card);
    });
  });
}

function selectEvent(date, ev, el){
  selectedEvents[date] = ev;
  Array.from(el.parentNode.querySelectorAll('.option')).forEach(child => child.classList.remove('selected'));
  el.classList.add('selected');
}

function goToDetails(){
  if(Object.keys(selectedEvents).length < selectedDates.length){ 
    alert("Selection Required: Please select an event for each chosen date."); 
    return; 
  }
  buildParticipantForms();
  buildPaymentSummary();
  nextStep(3);
}

function buildParticipantForms(){
  let html = `
    <div class="common-box">
      <span class="participant-title">Common Details</span>
      <div class="input-grid">
        <div class="input-wrapper"><i class="fas fa-university"></i><input id="common-college" placeholder="College Name" required></div>
        <div class="input-wrapper"><i class="fas fa-graduation-cap"></i><input id="common-dept" placeholder="Dept. & Year" required></div>
      </div>
    </div>`;

  Object.keys(selectedEvents).forEach(date=>{
    let ev=selectedEvents[date];
    html+=`
    <div class="summary-box">
      <h3 style="font-family:'Cinzel'; color:var(--gold); margin-bottom:15px; border-bottom:1px solid rgba(212,175,55,0.3); padding-bottom:5px;">
        ${date} – ${ev.name}
      </h3>
      <div class="input-wrapper" style="margin-bottom:20px;">
        <i class="fas fa-envelope"></i><input type="email" id="${date}-email" placeholder="E-Mail Address" required>
      </div>
      ${participantFields(ev, date)}
    </div>`;
  });
  document.getElementById("dynamicForm").innerHTML=html;
}

function participantFields(ev, date){
  let html = "";
  let count = (ev.type === "individual") ? 1 : 4;
  
  for(let i=1; i<=count; i++){
    let isRequired = "";
    let placeholder = `Participant ${i} Name`;
    
    if(ev.type === "individual") isRequired = "required";
    else if(ev.type === "biz") isRequired = "required";
    else if(i <= 2) isRequired = "required"; 
    else placeholder += " (Optional)";

    html += `
      <div class="participant-section">
        <span class="participant-title">Participant ${i} ${isRequired ? '' : '(Optional)'}</span>
        <div class="input-grid">
          <div class="input-wrapper"><i class="fas fa-user"></i><input id="${date}-p${i}-name" placeholder="${placeholder}" ${isRequired}></div>
          <div class="input-wrapper"><i class="fas fa-phone"></i>
            <input type="tel" id="${date}-p${i}-phone" placeholder="10-digit Phone" 
            pattern="[0-9]{10}" maxlength="10" ${isRequired}
            oninput="this.value = this.value.replace(/[^0-9]/g, '');">
          </div>
        </div>
      </div>`;
  }
  return html;
}

function validateStep3(){
  const college = document.getElementById('common-college').value.trim();
  const dept = document.getElementById('common-dept').value.trim();
  if(!college || !dept){ alert("Missing Common Details."); return; }

  for(let date in selectedEvents){
    let ev = selectedEvents[date];
    let email = document.getElementById(`${date}-email`).value.trim();
    if(!email || !email.includes('@')){ alert(`Valid email required for ${ev.name}.`); return; }

    let count = (ev.type === "individual") ? 1 : 4;
    for(let i=1; i<=count; i++){
      let name = document.getElementById(`${date}-p${i}-name`).value.trim();
      let phone = document.getElementById(`${date}-p${i}-phone`).value.trim();

      if(ev.type === "individual" || ev.type === "biz" || i <= 2){
        if(!name || phone.length !== 10){
          alert(`Participant ${i} details are compulsory for ${ev.name}.`);
          return;
        }
      } else if (name || phone) {
        if(!name || phone.length !== 10){
          alert(`Please complete optional Participant ${i} details or leave blank.`);
          return;
        }
      }
    }
  }
  nextStep(4);
}

function buildPaymentSummary(){
  let total=0;
  let html=`<div style="font-family:'Montserrat'; font-size:0.9rem;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid rgba(212,175,55,0.2); padding-bottom:5px;">
              <strong>EVENT</strong><strong>FEE</strong>
            </div>`;
  
  Object.keys(selectedEvents).forEach(date=>{
    let ev=selectedEvents[date];
    total+=ev.fee;
    html+=`<div style="display:flex; justify-content:space-between; margin-bottom:10px;">
      <span>${date} | ${ev.name}</span><span>₹${ev.fee}</span>
    </div>`;
  });
  
  html += `<div style="border-top:2px solid var(--gold); margin-top:10px; padding-top:10px; display:flex; justify-content:space-between;">
           <strong>TOTAL</strong><strong>₹${total}</strong></div></div>`;
           
  document.getElementById("paymentSummary").innerHTML = html;
  document.getElementById("totalAmount").innerText = total;
}

async function submitFinalRegistration(){
  const submitBtn = document.querySelector("button[onclick='submitFinalRegistration()']");
  const txn = document.getElementById("txnId").value.trim();
  const fileInput = document.getElementById("screenshot");
  const dec = document.getElementById("declaration").checked;

  if(!txn || fileInput.files.length === 0 || !dec){
    alert("Transaction ID, Screenshot, and Declaration are mandatory.");
    return;
  }

  // 2MB Limit Validation
  if(fileInput.files[0].size > 2 * 1024 * 1024){
    alert("Screenshot must be under 2MB.");
    return;
  }

  // Prevent Double Submission
  submitBtn.disabled = true;
  submitBtn.innerText = "Submitting...";

  const base64Image = await toBase64(fileInput.files[0]);

  const payload = {
    selectedEvents: Object.keys(selectedEvents).map(date => {
      const ev = selectedEvents[date];
      const participants = [];
      const count = (ev.type === "individual") ? 1 : 4;

      for(let i=1; i<=count; i++){
        let name = document.getElementById(`${date}-p${i}-name`).value.trim();
        let phone = document.getElementById(`${date}-p${i}-phone`).value.trim();
        if(name) participants.push({ name, phone });
      }

      return {
        date: date,
        eventName: ev.name,
        fee: ev.fee,
        email: document.getElementById(`${date}-email`).value.trim(),
        college: document.getElementById('common-college').value.trim(),
        department: document.getElementById('common-dept').value.trim(),
        participants: participants
      };
    }),
    totalAmount: parseInt(document.getElementById("totalAmount").innerText),
    transactionId: txn,
    paymentScreenshotBase64: base64Image
  };

  try {
    const response = await fetch("https://script.google.com/macros/s/AKfycbxBIzeQl_QZl7CwIwgb93COOrXf_DdUJbhJc0Hy4dLGFieGTcv1EId5v-v3u_ze2NI/exec", {
      method: "POST",
      body: JSON.stringify(payload),
      headers: { "Content-Type": "application/json" }
    });

    let result;
    try {
      result = await response.json();
    } catch (parseError) {
      alert("Unexpected server response. Please try again.");
      submitBtn.disabled = false;
      submitBtn.innerText = "Submit Registration";
      return;
    }

    if(result.status === "success"){
      const ids = result.registrations.map(r => r.registrationId);
  showSuccess(ids);
    } else {
      alert("Registration failed. Try again.");
      submitBtn.disabled = false;
      submitBtn.innerText = "Submit Registration";
    }

  } catch(error){
    console.error(error);
    alert("Server error. Try again later.");
    submitBtn.disabled = false;
    submitBtn.innerText = "Submit Registration";
  }
}

function showSuccess(registrationIds){
  let html = `
  <div style="text-align:center; padding:40px;">
    <i class="fas fa-check-circle" style="font-size:4rem; color:var(--gold); margin-bottom:20px;"></i>
    <h2 style="color:var(--gold); font-family:'Cinzel';">
      Registration Successful
    </h2>
    <p style="margin:20px 0;">
      Please save your Registration ID(s):
    </p>
  `;

  registrationIds.forEach(id => {
    html += `
      <div class="summary-box">
        <strong style="color:var(--gold); font-size:1.2rem;">
          ${id}
        </strong>
      </div>
    `;
  });

  html += `
    <p style="margin-top:20px;">
      Confirmation will be sent after payment verification.
    </p>
  </div>`;

  document.querySelector(".container").innerHTML = html;
}

const toBase64 = file => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
});
</script>

</body>
</html>
